---
title: "UK - Random Forest"
author: "Author_Name"
date: "5/21/2021"
output: html_document
---

### Model 2: After Decision, use Random Forest for another categorical Predict model
#### Training the model
```{r}

start_time <- Sys.time()

caret_rf <- train(x=train_sample_categorical[, !colnames(train_sample_categorical) %in% 'Accident_Severity'], y=train_sample_categorical$Accident_Severity,
                             data=train_sample_categorical, method='rf', tuneGrid=expand.grid(.mtry=c(5:10)),
                             trControl=trainControl(method="cv", number=10))
end_time <- Sys.time()
rf_runtime <- round(as.numeric(end_time - start_time), 2)
plot(caret_rf)
```

#### Testing the model
```{r}
test_sample_categorical$Predict <- predict(caret_rf, test_sample_categorical)
rf_conf_matrix <- confusionMatrix(data=test_sample_categorical$Predict, reference=test_sample_categorical$Accident_Severity)
test_sample_categorical <- test_sample_categorical %>%
  mutate(Predict = predict(caret_rf, test_sample_categorical),
         Predict_prob = predict(caret_rf, type="prob", test_sample_categorical)[,2],
         error = ifelse(Predict != Accident_Severity, 1, 0))

```


### ROC plot
```{r}
roc <- test_sample_categorical %>%
  select(Accident_Severity, Predict_prob) %>%
  mutate(Accident_Severity = as.numeric(Accident_Severity) - 1,
         Accident_Severity.str = c("Fatal_Serious", "Slight")[Accident_Severity + 1]) %>%
  ggplot(aes(m = Predict_prob, d = Accident_Severity)) +
  geom_roc(labels = F)
roc +
  style_roc(xlab = "False Positive Rate", ylab = "True Positive Rate", theme = theme_bw) +
  theme(panel.border = element_blank(), panel.grid.major = element_blank(),
        axis.line = element_line(colour = "grey")) +
  ggtitle("Random Forest - ROC Curve") +
  annotate("text", x = .75, y = .25,
           label = paste("AuROC=", round(calc_auc(roc)$AUC, 3)))
```

### Model Evaluation
####Score list
```{r}


rf_accuracy <- round(rf_conf_matrix$overall['Accuracy'], 3)
rf_precision <- round(rf_conf_matrix$byClass['Pos Predict Value'], 3)
rf_recall <- round(rf_conf_matrix$byClass['Sensitivity'], 3)
rf_f1_score <- round(2*((rf_precision * rf_recall) / (rf_precision + rf_recall)), 3)
rf_roc <- round(calc_auc(roc)$AUC, 3)

#use of test
test_sample_categorical <- test_sample_categorical[ , !(names(test_sample_categorical) %in% c('Predict', 'Predict_prob', 'error'))]

#accuracy readings
data.frame(rf_accuracy, accuracy_baseline, rf_precision, rf_f1_score, rf_recall, rf_roc)
```


#### Variable Importance
```{r}
rf_imp <- varImp( scale=F, caret_rf)
rf_imp <- rf_imp$importance
rf_gini <- data.frame(Variables=row.names(rf_imp), MeanDecreaseGini=rf_imp$Overall)
rf_imp_plot <- ggplot(rf_gini, aes(y=MeanDecreaseGini,x=reorder(Variables, MeanDecreaseGini),fill=MeanDecreaseGini)) +
  geom_bar(stat='identity') + theme(legend.position="none") + coord_flip() + labs(x="") +
  ggtitle('Random Forest model Variable Importance') + theme(plot.title = element_text(hjust=0.5))
rf_imp_plot
rm(rf_gini, rf_imp)

```

#### compare VI of RF and DT
```{r}
grid.arrange(rf_imp_plot, dt_imp_plot, ncol=2)
rm(rf_imp_plot, dt_imp_plot)
```


#### Cleaning and removing noise
```{r}


set.seed(124)
sample_data <- createDataPartition(sampled_categorical$Accident_Severity, list=F, p=0.5)
sampled_num <- sampled_categorical[sample_data, ]

#Removing noise by using Variable importance of the Random Forest and Decision Tree models
sampled_num <- as_tibble(sampled_num[ , !(names(sampled_num) %in%
                                                              c('High_Wind', 'Propulsion_Code'))])
sampled_num <- dummy_cols(sampled_num,
                                   select_columns = c('X1st_Road_Class', 'Region', 'Urban_or_Rural_Area',
                                                      'Road_Surface_Conditions', 'Road_Type', 'Weather',
                                                       'Junction_Detail', 'Lights',
                                                      'X1st_Point_of_Impact','Junction_Location', 
                                                      'Vehicle_Make', 'Driver_Journey_Purpose', 
                                                      'Vehicle_Manoeuvre', 'Vehicle_Category'),
                          remove_most_frequent_dummy=T)
drop_columns <- c('Urban_or_Rural_Area', 'Region', 'X1st_Road_Class', 'Junction_Detail', 'Road_Surface_Conditions',
                  'Road_Type','Weather', 'Lights', 'Junction_Location', 'X1st_Point_of_Impact',
                  'Driver_Journey_Purpose', 'Vehicle_Category','Vehicle_Make', 'Vehicle_Manoeuvre')

sampled_num <- sampled_num[ , !(names(sampled_num) %in% drop_columns)]
rm(drop_columns)

sampled_normal <- predict(preProcess(sampled_num, method=c("scale","center")),
                                 sampled_num)

sampled_normal <- dummy_cols(sampled_normal, select_columns = c('Accident_Severity'),
                                    remove_most_frequent_dummy=T)
names(sampled_normal)[names(sampled_normal) == 'Accident_Severity_Fatal_Serious'] <- 'Fatal_or_Serious_Accident'

sampled_num <- select(sampled_normal, -matches("Accident_Severity"))
sampled_normal <- select(sampled_normal, -matches("Fatal_or_Serious_Accident"))
```
